        def _on_gallery_select(evt, state):
            """Handle gallery selection events.

            This function must return three values corresponding to the outputs
            [selected_md, selected_state, gen_model_info]. Always return a
            (html, state, markdown) tuple even when no selection is present.
            """
            try:
                evt_type = type(evt).__name__
                print(f"[DBG] gallery select event type: {evt_type}")
                if isinstance(evt, (list, tuple)) and evt:
                    sample = evt[0]
                    if isinstance(sample, dict):
                        print("[DBG] gallery event[0] keys:", list(sample.keys()))
                        preview = {k: sample[k] for k in list(sample.keys())[:4]}
                        print("[DBG] gallery event[0] preview:", preview)
                    elif isinstance(sample, (list, tuple)):
                        print("[DBG] gallery event[0] nested type:", type(sample[0]).__name__)
                        print("[DBG] gallery event[0] value sample:", sample[:3])
                elif isinstance(evt, dict):
                    print("[DBG] gallery event dict keys:", list(evt.keys()))
                    print("[DBG] gallery event dict preview:", {k: evt[k] for k in list(evt.keys())[:4]})
                else:
                    print("[DBG] gallery event payload:", evt)
            except Exception:
                pass

            # no selection case: return three values (html, state, markdown)
            if evt is None:
                return "**Selected model:** None", state, ""

            # try to extract an index or value from evt; support multiple evt shapes
            selected = None
            idx = None
            try:
                # plain int or numeric string
                if isinstance(evt, int):
                    idx = int(evt)
                elif isinstance(evt, str) and evt.isdigit():
                    idx = int(evt)
                elif hasattr(evt, "index"):
                    try:
                        idx = int(getattr(evt, "index"))
                    except Exception:
                        idx = None
                elif hasattr(evt, "value"):
                    try:
                        idx = int(getattr(evt, "value"))
                    except Exception:
                        idx = None
                elif isinstance(evt, dict):
                    # common keys: index, value, image, src
                    if 'index' in evt:
                        try:
                            idx = int(evt.get('index'))
                        except Exception:
                            idx = None
                    elif 'value' in evt:
                        try:
                            idx = int(evt.get('value'))
                        except Exception:
                            idx = None
                    elif 'image' in evt or 'src' in evt:
                        # try to locate model by matching cover/src
                        img_lookup = evt.get('image') or evt.get('src')
                        models = state or []
                        for i, mm in enumerate(models):
                            if mm.get('cover') == img_lookup or mm.get('cover') == evt.get('image'):
                                idx = i
                                break
                    elif 'name' in evt and isinstance(evt.get('name'), str) and evt['name'].isdigit():
                        idx = int(evt['name'])
                    elif 'caption' in evt and evt['caption']:
                        caption = str(evt['caption'])
                        models = state or []
                        for i, mm in enumerate(models):
                            if str(mm.get('title')) == caption or str(mm.get('id')) == caption:
                                idx = i
                        else:
                            selected_model = match_candidate(evt)
                                break
                elif isinstance(evt, (list, tuple)) and len(evt) > 0:
                    first = evt[0]
                    if isinstance(first, (int, str)) and str(first).isdigit():
                        idx = int(first)
                    elif isinstance(first, dict) and ('index' in first or 'value' in first or 'image' in first):
                        # normalize from nested item
                        if 'index' in first and str(first['index']).isdigit():
                            idx = int(first['index'])
                        elif 'value' in first and str(first['value']).isdigit():
                            idx = int(first['value'])
                        else:
                            img_lookup = first.get('image') or first.get('src')
                            models = state or []
                            for i, mm in enumerate(models):
                                if mm.get('cover') == img_lookup:
                                    idx = i
                                    break
                    elif isinstance(first, (list, tuple)) and len(first) >= 1:
                        # typical gallery payload: (image, caption)
                        img_lookup = first[0]
                        title_lookup = first[1] if len(first) > 1 else None
                        models = state or []
                        for i, mm in enumerate(models):
                            if (
                                mm.get('cover') == img_lookup
                                or str(mm.get('title')) == str(title_lookup)
                                or str(mm.get('id')) == str(title_lookup)
                            ):
                                idx = i
                                break
                elif isinstance(evt, tuple) and len(evt) >= 1:
                    # direct tuple selection (image, caption)
                    img_lookup = evt[0]
                    title_lookup = evt[1] if len(evt) > 1 else None
                    models = state or []
                    for i, mm in enumerate(models):
                        if (
                            mm.get('cover') == img_lookup
                            or str(mm.get('title')) == str(title_lookup)
                            or str(mm.get('id')) == str(title_lookup)
                        ):
                            idx = i
                            break
                else:
                    # fallback: try to stringify
                    try:
                        s = str(evt)
                        if s.isdigit():
                            idx = int(s)
                    except Exception:
                        idx = None
            except Exception:
                idx = None

            # load models list and guard bounds
            models = state or []

            if idx is None or idx < 0 or idx >= len(models):
                # selection couldn't be mapped to a model index
                return "**Selected model:** None", state, ""

            m = models[idx]
            title = (m.get('title_cn') or m.get('title_en') or m.get('id') or '')

            # selection summary for the Selection pane
            md = (
                f"<div><strong>Selected model:</strong> {title}</div>\n"
                f"<div style='margin-top:8px; font-size:13px; color:#a6adc8'>ID: {m.get('id')} · Author: {m.get('author')} · Downloads: {m.get('downloads')} · Likes: {m.get('likes')}</div>"
            )

            gen_md = (
                f"### {title}\n\n- **ID:** {m.get('id')}  \n- **Author:** {m.get('author')}  \n- **Downloads:** {m.get('downloads')}  \n- **Likes:** {m.get('likes')}  \n- **Updated:** {m.get('updated_at') or ''}  \n- **URL:** [{m.get('modelscope_url')}]({m.get('modelscope_url')})"
            )

            # return Selection HTML, new state (the selected model dict), and generate markdown
            return md, m, gen_md
